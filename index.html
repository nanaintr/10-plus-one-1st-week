<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ğŸš´ê´‘ëª… ê²½ë¥œ 10+1 1ë§Œì› ë“œë¦¼ í”„ë¡œëª¨ì…˜ 2ì°¨ ì¿ í° ë‹¹ì²¨ ì¡°íšŒğŸš´</title>

  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
</head>

<body class="bg-slate-100 min-h-screen">
  <div class="max-w-3xl mx-auto px-4 py-8">
    <h1 class="text-2xl font-bold text-slate-800 mb-2">
      ğŸš´ê´‘ëª… ê²½ë¥œ 10+1 1ë§Œì› ë“œë¦¼ í”„ë¡œëª¨ì…˜ 2ì°¨ ì¿ í° ë‹¹ì²¨ ì¡°íšŒğŸš´
    </h1>
    <p class="text-sm text-slate-600 mb-6">
      íœ´ëŒ€ì „í™” ë²ˆí˜¸ <span class="font-semibold">ê°€ìš´ë° 4ìë¦¬</span>ë¥¼ ì…ë ¥í•˜ë©´ ì¿ í° ë‹¹ì²¨ ì—¬ë¶€ë¥¼ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.<br>
      ì˜ˆ: ë²ˆí˜¸ê°€ <span class="font-mono">010-<span class="underline">1234</span>-5678</span> ì´ë¼ë©´ <span class="font-mono">1234</span> ì…ë ¥
    </p>

    <form id="search-form" class="flex flex-col sm:flex-row gap-3 items-start sm:items-center mb-4">
      <div class="flex items-center gap-2">
        <label for="mid4" class="text-sm font-medium text-slate-700 whitespace-nowrap">
          íœ´ëŒ€í° ê°€ìš´ë° 4ìë¦¬
        </label>
        <input
          id="mid4"
          type="text"
          inputmode="numeric"
          maxlength="4"
          class="w-28 px-3 py-2 border border-slate-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 font-mono text-center"
          placeholder="1234"
        />
      </div>
      <button
        type="submit"
        class="px-4 py-2 bg-blue-600 text-white rounded-md shadow hover:bg-blue-700 transition text-sm font-medium"
      >
        ì¡°íšŒí•˜ê¸°
      </button>
    </form>

    <div id="status" class="text-sm text-slate-600 mb-3">
      ë°ì´í„° ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ì…ë‹ˆë‹¤â€¦
    </div>

    <div id="results-container" class="bg-white border border-slate-200 rounded-lg shadow-sm overflow-hidden hidden">
      <table class="min-w-full text-sm">
        <thead class="bg-slate-50 border-b border-slate-200">
          <tr>
            <th class="px-4 py-2 text-left font-semibold text-slate-700">ì´ë¦„</th>
            <th class="px-4 py-2 text-left font-semibold text-slate-700">íœ´ëŒ€í°ë²ˆí˜¸</th>
            <th class="px-4 py-2 text-right font-semibold text-slate-700">ì¿ í°ê¸ˆì•¡</th>
          </tr>
        </thead>
        <tbody id="results-body" class="divide-y divide-slate-100"></tbody>
      </table>
    </div>
  </div>

  <script>
    // âœ… êµ¬ê¸€ ì‹œíŠ¸ "ì›¹ì— ê²Œì‹œ" CSV URL
    const CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vTcabHB4nh1SOD6U4adGjJ97PXhE6N2Lk8Zn2znqTImDyPnN2QNC3FPez7eOeWYu_nMS9_OSKOImlLE/pub?output=csv";

    // âœ… ì‹œíŠ¸ í—¤ë”(ì»¬ëŸ¼ëª…) í›„ë³´ë“¤
    const NAME_KEYS = ["ì´ë¦„", "ì´ë¦„(ê°œì¸ì •ë³´ë³´í˜¸)"];
    const PHONE_KEYS = ["íœ´ëŒ€í°ë²ˆí˜¸", "íœ´ëŒ€í°ë²ˆí˜¸(ê°œì¸ì •ë³´ë³´í˜¸)"];
    const COUPON_KEYS = ["ì¿ í°ê¸ˆì•¡", "ì¿ í° ê¸ˆì•¡"];

    let rows = [];
    let isLoaded = false;

    const statusEl = document.getElementById("status");
    const resultsContainer = document.getElementById("results-container");
    const resultsBody = document.getElementById("results-body");
    const form = document.getElementById("search-form");
    const mid4Input = document.getElementById("mid4");

    // âœ… ìœ í‹¸: rowì—ì„œ ê°€ëŠ¥í•œ í‚¤ë“¤ ì¤‘ ì‹¤ì œ ì¡´ì¬í•˜ëŠ” ê°’ì„ êº¼ë‚´ê¸°
    function getField(row, keys) {
      for (const k of keys) {
        if (k in row) return row[k];
      }
      return "";
    }

    // âœ… ìœ í‹¸: ì „í™”ë²ˆí˜¸ì—ì„œ ìˆ«ìë§Œ ì¶”ì¶œ
    function onlyDigits(s) {
      return (s || "").toString().replace(/\D/g, ""); // ìˆ«ì ì´ì™¸ ì œê±°
    }

    // âœ… ìœ í‹¸: "ê°€ìš´ë° 4ìë¦¬" ì¶”ì¶œ (í•œêµ­ íœ´ëŒ€í° 11ìë¦¬ ê¸°ì¤€)
    function getMiddle4(phoneRaw) {
      const d = onlyDigits(phoneRaw);
      // 010xxxxxxxx í˜•íƒœ(11ìë¦¬)ë©´ ê°€ìš´ë° 4ìë¦¬ëŠ” 4~7ë²ˆì§¸(0-index 3~6)
      if (d.length === 11) return d.slice(3, 7);
      // í˜¹ì‹œ 10ìë¦¬ ë“± ì˜ˆì™¸ê°€ ìˆìœ¼ë©´ ì•ˆì „í•˜ê²Œ ì²˜ë¦¬(ê°€ìš´ë° 4 ë¹„ìŠ·í•˜ê²Œ)
      if (d.length >= 7) return d.slice(3, 7);
      return "";
    }

    // âœ… CSV ë¡œë”©
    function loadData() {
      statusEl.textContent = "ë°ì´í„° ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ì…ë‹ˆë‹¤â€¦";

      Papa.parse(CSV_URL, {
        download: true,
        header: true,
        skipEmptyLines: true,
        complete: (results) => {
          rows = results.data || [];
          isLoaded = true;
          statusEl.textContent = `ë°ì´í„° ë¡œë“œ ì™„ë£Œ! (ì´ ${rows.length}ê±´) ê°€ìš´ë° 4ìë¦¬ë¥¼ ì…ë ¥í•´ ì¡°íšŒí•˜ì„¸ìš”.`;
        },
        error: () => {
          statusEl.textContent = "ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤. (ì‹œíŠ¸ ê³µê°œ/CSV URL í™•ì¸ í•„ìš”)";
        }
      });
    }

    // âœ… ê²€ìƒ‰ ì²˜ë¦¬
    form.addEventListener("submit", (e) => {
      e.preventDefault();

      if (!isLoaded) {
        statusEl.textContent = "ì•„ì§ ë°ì´í„° ë¡œë”© ì¤‘ì…ë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.";
        return;
      }

      const mid4 = (mid4Input.value || "").trim();

      // ì…ë ¥ê°’ ê²€ì¦(ìˆ«ì 4ìë¦¬)
      if (!/^\d{4}$/.test(mid4)) {
        statusEl.textContent = 'íœ´ëŒ€ì „í™” ê°€ìš´ë° 4ìë¦¬ë¥¼ ìˆ«ì 4ìë¦¬ë¡œ ì…ë ¥í•´ì£¼ì„¸ìš”. (ì˜ˆ: 1234)';
        resultsContainer.classList.add("hidden");
        resultsBody.innerHTML = "";
        return;
      }

      // âœ… ê°€ìš´ë° 4ìë¦¬ë¡œ ë§¤ì¹­
      const matches = rows.filter(row => {
        const phone = getField(row, PHONE_KEYS);
        return getMiddle4(phone) === mid4;
      });

      if (matches.length === 0) {
        statusEl.textContent =
          "ì£„ì†¡í•©ë‹ˆë‹¤.ğŸ˜¢ ì…ë ¥í•˜ì‹  ë²ˆí˜¸ì™€ ì¼ì¹˜í•˜ëŠ” ì¿ í° ë‹¹ì²¨ ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤. ë‹¤ìŒ ê¸°íšŒì— ë‹¤ì‹œ ë„ì „í•´ì£¼ì„¸ìš”.";
        resultsContainer.classList.add("hidden");
        resultsBody.innerHTML = "";
        return;
      }

      // ê²°ê³¼ ë Œë”
      resultsBody.innerHTML = "";
      matches.forEach(row => {
        const name = getField(row, NAME_KEYS) || "";
        const phone = getField(row, PHONE_KEYS) || "";
        const coupon = getField(row, COUPON_KEYS) || "";

        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td class="px-4 py-2 text-slate-800">${name}</td>
          <td class="px-4 py-2 font-mono text-slate-700">${phone}</td>
          <td class="px-4 py-2 text-right text-slate-800 font-semibold">${coupon}</td>
        `;
        resultsBody.appendChild(tr);
      });

      statusEl.innerHTML =
        "ì¶•í•˜ë“œë ¤ìš”! ğŸ¥³ğŸ‘ ì•„ë˜ì—ì„œ ë‹¹ì²¨ ê²°ê³¼ë¥¼ í™•ì¸í•´ì£¼ì„¸ìš”.<br>ì´ " +
        matches.length +
        "ê±´ì˜ ë‹¹ì²¨ ë‚´ì—­ì´ ìˆìŠµë‹ˆë‹¤.";

      resultsContainer.classList.remove("hidden");
    });

    window.addEventListener("DOMContentLoaded", loadData);
  </script>
</body>
</html>
